---
phase: 01-foundation-cam-state-access
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Fusion-360-MCP-Server/cam_operations.py
autonomous: false

must_haves:
  truths:
    - "AI receives numeric values with explicit units in all CAM responses"
    - "AI can query tool library and receive full tool properties"
    - "AI receives WCS information per setup in get_cam_state"
    - "Operations work correctly in Fusion 360"
  artifacts:
    - path: "Fusion-360-MCP-Server/cam_operations.py"
      provides: "CAM MCP operations with explicit unit responses"
      contains: "_to_mm"
      min_lines: 400
  key_links:
    - from: "mcp_integration.py"
      to: "cam_operations.route_cam_operation"
      via: "operation routing"
      pattern: "cam_operations\\.route_cam_operation"
    - from: "handle_get_cam_state"
      to: "_to_mm helper"
      via: "unit conversion"
      pattern: "_to_mm\\("
    - from: "handle_get_tool_library"
      to: "_to_mm helper"
      via: "unit conversion"
      pattern: "_to_mm\\("
---

<objective>
Enhance CAM operations to return responses with explicit units and full property definitions per CONTEXT.md locked decisions.

Purpose: AI agents need unambiguous responses where all numeric values include units explicitly (`{"value": 10, "unit": "mm"}`). Tool queries must return full Fusion tool properties. WCS information must be included per setup.

Output: Enhanced `cam_operations.py` with standardized response structures that match the locked decisions from phase context discussion.
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-cam-state-access/01-CONTEXT.md
@.planning/phases/01-foundation-cam-state-access/01-RESEARCH.md
@Fusion-360-MCP-Server/cam_operations.py
@Fusion-360-MCP-Server/mcp_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor CAM operations with explicit units and enhanced WCS</name>
  <files>Fusion-360-MCP-Server/cam_operations.py</files>
  <action>
Refactor `cam_operations.py` to implement LOCKED decisions from CONTEXT.md:

1. **Add unit conversion helper** (from RESEARCH.md Pattern 2):
```python
def _to_mm(cm_value: float) -> dict:
    """Convert internal cm to mm with explicit units."""
    if cm_value is None:
        return None
    return {
        "value": round(cm_value * 10, 3),
        "unit": "mm"
    }
```

2. **Refactor `handle_get_cam_state`**:
   - Stock dimensions: Change from string expressions to `{"value": X, "unit": "mm"}` format
   - For FixedBoxStock, convert numeric values using `_to_mm()`
   - For RelativeBoxStock offsets, use same format
   - Tool diameter in operations: Use `_to_mm(tool.diameter)` instead of `tool.diameter * 10`

3. **Enhance WCS extraction** per CONTEXT.md:
   - Extract Z origin with both expression and numeric value
   - Include orientation info if available
   - Format: `{"z_origin": {"expression": "Stock Top", "value": {"value": 0, "unit": "mm"}}}`
   - Use try-except for optional parameters (per RESEARCH.md Pitfall 3)

4. **Refactor `handle_get_tool_library`**:
   - Change `diameter_mm` to `diameter: {"value": X, "unit": "mm"}`
   - Change `flute_length_mm` to `flute_length: {"value": X, "unit": "mm"}`
   - Change `overall_length_mm` to `overall_length: {"value": X, "unit": "mm"}`
   - Change all `*_mm` fields to explicit unit objects
   - Add missing tool properties from Fusion API:
     - `helix_angle` (if available via `tool.helixAngle`)
     - `coating` (if available via `tool.coating`)
     - Full vendor info
     - `coolant_support` (if available)

IMPORTANT: Keep existing error handling patterns. Wrap new property access in try-except per RESEARCH.md guidance on hidden parameters.

Do NOT modify `mcp_integration.py` - routing already works correctly.
  </action>
  <verify>
Run syntax check: `python -m py_compile Fusion-360-MCP-Server/cam_operations.py`

Grep for unit pattern: `grep -n "_to_mm\|\"unit\":" Fusion-360-MCP-Server/cam_operations.py`
  </verify>
  <done>
- `_to_mm()` helper function exists and is used throughout
- All diameter, length, dimension fields use `{"value": X, "unit": "mm"}` format
- No `*_mm` suffixed field names remain (replaced with unit objects)
- WCS info includes expression and numeric value with units
- Tool library returns additional properties (helix_angle, coating) when available
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify CAM operations in Fusion 360</name>
  <what-built>
Enhanced CAM operations with explicit units in all responses:
- `get_cam_state` - Returns setup/operation info with unit objects
- `get_tool_library` - Returns full tool definitions with unit objects
  </what-built>
  <how-to-verify>
1. Start Fusion 360 with MCP-Link add-in loaded
2. Open a document with CAM setups (or create a simple test setup)
3. Via MCP client, call: `{"operation": "get_cam_state"}`
   - Verify response includes `"unit": "mm"` in stock dimensions
   - Verify WCS info is present and includes units
   - Verify tool info (if operations exist) includes unit objects
4. Via MCP client, call: `{"operation": "get_tool_library", "limit": 5}`
   - Verify tool diameter is `{"value": X, "unit": "mm"}` format
   - Verify flute_length, overall_length etc use unit objects
   - Verify additional properties appear (helix_angle, coating if available)
5. Test with filter: `{"operation": "get_tool_library", "filter": {"type": ["endmill"], "diameter_range": [3, 10]}, "limit": 10}`
   - Verify filtering still works correctly
  </how-to-verify>
  <resume-signal>Type "approved" if responses match expected format, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] `_to_mm()` helper exists in cam_operations.py
- [ ] `get_cam_state` returns stock dimensions with unit objects
- [ ] `get_cam_state` returns WCS info with expression and value
- [ ] `get_tool_library` returns tools with unit objects (not *_mm suffixes)
- [ ] Additional tool properties available when Fusion provides them
- [ ] MCP operations work in Fusion 360 (human verified)
</verification>

<success_criteria>
Phase 1 complete when:
1. All CAM operation responses use explicit units format
2. Tool library returns full property definitions
3. WCS information included per setup
4. Human verification confirms operations work in Fusion 360
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-cam-state-access/01-01-SUMMARY.md`
</output>

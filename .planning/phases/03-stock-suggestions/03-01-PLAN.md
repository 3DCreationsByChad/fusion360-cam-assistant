---
phase: 03-stock-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Fusion-360-MCP-Server/stock_suggestions/__init__.py
  - Fusion-360-MCP-Server/stock_suggestions/stock_sizes.py
  - Fusion-360-MCP-Server/stock_suggestions/stock_calculator.py
autonomous: true

must_haves:
  truths:
    - "Stock dimensions are calculated from bounding box with configurable offsets"
    - "Dimensions are rounded to standard stock sizes based on unit system"
    - "Default offsets are 5mm XY and 2.5mm Z per CONTEXT.md"
  artifacts:
    - path: "Fusion-360-MCP-Server/stock_suggestions/__init__.py"
      provides: "Module exports for stock utilities"
      min_lines: 10
    - path: "Fusion-360-MCP-Server/stock_suggestions/stock_sizes.py"
      provides: "Standard stock size tables (metric/imperial)"
      contains: "METRIC_PLATE_THICKNESSES_MM"
    - path: "Fusion-360-MCP-Server/stock_suggestions/stock_calculator.py"
      provides: "Stock dimension calculation with offset application"
      exports: ["calculate_stock_dimensions", "round_to_standard_size"]
  key_links:
    - from: "stock_calculator.py"
      to: "stock_sizes.py"
      via: "import for standard size tables"
      pattern: "from.*stock_sizes import"
---

<objective>
Create stock dimension calculation utilities with standard size rounding.

Purpose: Provide foundation for stock suggestions - calculating raw dimensions from bounding box, applying machining offsets, and rounding to standard stock sizes available from suppliers.

Output:
- `stock_suggestions/` module with stock size tables and dimension calculator
- Support for metric and imperial unit systems
- Configurable offsets with sensible defaults (5mm XY, 2.5mm Z)
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-suggestions/03-CONTEXT.md
@.planning/phases/03-stock-suggestions/03-RESEARCH.md
@Fusion-360-MCP-Server/geometry_analysis/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stock sizes module with standard size tables</name>
  <files>
    Fusion-360-MCP-Server/stock_suggestions/__init__.py
    Fusion-360-MCP-Server/stock_suggestions/stock_sizes.py
  </files>
  <action>
Create the stock_suggestions directory and stock_sizes.py with standard stock size tables:

1. Create `Fusion-360-MCP-Server/stock_suggestions/` directory

2. Create `stock_sizes.py` with:
   - METRIC_PLATE_THICKNESSES_MM: [3, 4, 5, 6, 8, 10, 12, 15, 16, 18, 20, 22, 25, 30, 32, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 90, 100]
   - METRIC_BAR_WIDTHS_MM: [10, 12, 15, 16, 18, 20, 22, 25, 30, 32, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 90, 100, 110, 120, 130, 140, 150, 160, 180, 200, 220, 250, 300]
   - METRIC_ROUND_DIAMETERS_MM: [6, 8, 10, 12, 14, 15, 16, 18, 20, 22, 25, 28, 30, 32, 35, 38, 40, 42, 45, 48, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, 110, 120, 130, 150]
   - IMPERIAL_PLATE_THICKNESSES_IN: [0.125, 0.1875, 0.25, 0.3125, 0.375, 0.4375, 0.5, 0.625, 0.75, 0.875, 1.0, 1.25, 1.5, 1.75, 2.0, 2.5, 3.0, 3.5, 4.0]
   - IMPERIAL_BAR_WIDTHS_IN: [0.5, 0.625, 0.75, 0.875, 1.0, 1.125, 1.25, 1.375, 1.5, 1.75, 2.0, 2.25, 2.5, 2.75, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 7.0, 8.0, 9.0, 10.0, 12.0]
   - IMPERIAL_ROUND_DIAMETERS_IN: [0.25, 0.3125, 0.375, 0.4375, 0.5, 0.5625, 0.625, 0.75, 0.875, 1.0, 1.125, 1.25, 1.375, 1.5, 1.625, 1.75, 2.0, 2.25, 2.5, 2.75, 3.0, 3.5, 4.0]

3. Add `round_to_standard_size(dimension_mm, unit_system, dimension_type)` function:
   - dimension_type: "width", "thickness", or "round_diameter"
   - For metric: directly find next larger size in mm
   - For imperial: convert to inches, find next larger, convert back to mm
   - Return largest available if all sizes are smaller
   - Include docstring explaining the rounding logic

4. Create `__init__.py` that exports:
   - All size tables
   - round_to_standard_size function

Follow the pattern from geometry_analysis/__init__.py for module structure.
  </action>
  <verify>
    - Directory exists: Fusion-360-MCP-Server/stock_suggestions/
    - Files exist: __init__.py, stock_sizes.py
    - Python syntax valid: python -c "from stock_suggestions import stock_sizes; print(len(stock_sizes.METRIC_BAR_WIDTHS_MM))"
  </verify>
  <done>
    - stock_sizes.py contains all 6 standard size tables
    - round_to_standard_size function rounds up to next available size
    - Module is importable with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stock calculator with offset application</name>
  <files>
    Fusion-360-MCP-Server/stock_suggestions/stock_calculator.py
    Fusion-360-MCP-Server/stock_suggestions/__init__.py
  </files>
  <action>
Create stock_calculator.py with dimension calculation and offset logic:

1. Create `stock_calculator.py` with:

2. Define DEFAULT_OFFSETS dict:
   ```python
   DEFAULT_OFFSETS = {
       "xy_mm": 5.0,   # Per CONTEXT.md: 5mm XY offset (applied to all 4 sides)
       "z_mm": 2.5     # Per CONTEXT.md: 2.5mm Z offset (top only)
   }
   ```

3. Create `calculate_stock_dimensions(bbox, offsets=None, round_to_standard=True, unit_system="metric")`:
   - bbox: adsk.core.BoundingBox3D from body.boundingBox
   - Extract dimensions: x/y/z from bbox (convert cm to mm by *10)
   - Apply offsets: XY offset on all 4 sides (total = 2x offset), Z offset top-only
   - If round_to_standard=True, call round_to_standard_size for each dimension
   - Return dict with:
     ```python
     {
         "width": {"value": X, "unit": "mm"},
         "depth": {"value": Y, "unit": "mm"},
         "height": {"value": Z, "unit": "mm"},
         "raw_dimensions": {"width": raw_x, "depth": raw_y, "height": raw_z},
         "offsets_applied": offsets,
         "rounded_to_standard": round_to_standard,
         "unit_system": unit_system
     }
     ```
   - Include docstring explaining offset application (XY: per-side, Z: top-only)

4. Import from stock_sizes: round_to_standard_size

5. Update `__init__.py` to export:
   - DEFAULT_OFFSETS
   - calculate_stock_dimensions
   - round_to_standard_size (re-export from stock_sizes)
  </action>
  <verify>
    - File exists: Fusion-360-MCP-Server/stock_suggestions/stock_calculator.py
    - Python syntax valid: python -c "from stock_suggestions import calculate_stock_dimensions, DEFAULT_OFFSETS; print(DEFAULT_OFFSETS)"
    - Test calculation: dimensions match expected offset application
  </verify>
  <done>
    - calculate_stock_dimensions applies XY offset (2x per side) and Z offset (top only)
    - Default offsets are 5mm XY, 2.5mm Z per CONTEXT.md
    - Dimensions rounded to standard sizes when round_to_standard=True
    - Module exports all functions via __init__.py
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Import test: `python -c "from stock_suggestions import calculate_stock_dimensions, round_to_standard_size, DEFAULT_OFFSETS, METRIC_BAR_WIDTHS_MM; print('OK')"`
2. Verify DEFAULT_OFFSETS matches CONTEXT.md: xy_mm=5.0, z_mm=2.5
3. Verify round_to_standard_size(45.5, "metric", "width") returns 50 (next larger)
4. Verify round_to_standard_size(1.1, "imperial", "width") returns ~28.575mm (1.125" in mm)
</verification>

<success_criteria>
- stock_suggestions module is importable
- Standard size tables cover common metric and imperial stock
- calculate_stock_dimensions correctly applies offset logic (XY: per-side, Z: top-only)
- round_to_standard_size rounds UP to next available standard size
- All values use explicit unit format {"value": X, "unit": "mm"}
</success_criteria>

<output>
After completion, create `.planning/phases/03-stock-suggestions/03-01-SUMMARY.md`
</output>

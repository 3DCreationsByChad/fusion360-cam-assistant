---
phase: 03-stock-suggestions
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - Fusion-360-MCP-Server/cam_operations.py
autonomous: false

must_haves:
  truths:
    - "User receives stock suggestion with dimensions rounded to standard sizes"
    - "Orientation recommendation includes setup sequence even for single-setup parts"
    - "User is prompted when no preference exists for material + geometry type"
    - "User is prompted to choose orientation when confidence is low"
    - "Source attribution shows 'from: user_preference' or 'from: default'"
    - "Cylindrical parts show both round and rectangular stock options"
  artifacts:
    - path: "Fusion-360-MCP-Server/cam_operations.py"
      provides: "handle_suggest_stock_setup function"
      contains: "def handle_suggest_stock_setup"
  key_links:
    - from: "cam_operations.py"
      to: "stock_suggestions module"
      via: "import for calculation utilities"
      pattern: "from stock_suggestions import"
    - from: "cam_operations.py"
      to: "geometry_analysis module"
      via: "import for OrientationAnalyzer"
      pattern: "OrientationAnalyzer"
    - from: "cam_operations.py"
      to: "route_cam_operation"
      via: "handler registration"
      pattern: "'suggest_stock_setup'.*handle_suggest_stock_setup"
---

<objective>
Create the suggest_stock_setup handler with full prompting logic.

Purpose: Main MCP operation that suggests stock setup based on geometry analysis, leveraging all Phase 3 utilities. Implements interactive prompting per CONTEXT.md when preferences don't exist or confidence is low.

Output:
- `handle_suggest_stock_setup` function in cam_operations.py
- Registered in route_cam_operation handlers
- Human verification checkpoint to test in Fusion 360
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stock-suggestions/03-CONTEXT.md
@.planning/phases/03-stock-suggestions/03-RESEARCH.md
@.planning/phases/03-stock-suggestions/03-01-SUMMARY.md
@.planning/phases/03-stock-suggestions/03-02-SUMMARY.md
@Fusion-360-MCP-Server/cam_operations.py
@Fusion-360-MCP-Server/stock_suggestions/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement handle_suggest_stock_setup handler</name>
  <files>
    Fusion-360-MCP-Server/cam_operations.py
  </files>
  <action>
Add the handle_suggest_stock_setup function to cam_operations.py:

1. Add imports at top of file (after existing imports):
   ```python
   try:
       from stock_suggestions import (
           calculate_stock_dimensions,
           DEFAULT_OFFSETS,
           detect_cylindrical_part,
           get_preference,
           save_preference,
           initialize_schema,
           classify_geometry_type
       )
       STOCK_SUGGESTIONS_AVAILABLE = True
   except ImportError:
       STOCK_SUGGESTIONS_AVAILABLE = False
   ```

2. Create `handle_suggest_stock_setup(arguments: dict) -> dict`:

   Arguments:
   - body_name (str, optional): Specific body to analyze (default: first body)
   - material (str, optional): Material for preference lookup
   - use_defaults (bool): If true, skip preference check and use defaults
   - save_preference (bool): If true, save current values as new preference
   - custom_offsets (dict): Override offsets {xy_mm, z_mm}
   - round_to_standard (bool): Round to standard sizes (default: true)
   - selected_orientation (str): User's orientation choice when prompted

   Implementation steps:
   a. Check STOCK_SUGGESTIONS_AVAILABLE, error if not
   b. Get app, design, check for active design
   c. Get body by name or first body
   d. Detect unit system from design.unitsManager.defaultLengthUnits ("mm" or "in")
   e. Get material from body.material.name or arguments, default "unknown"
   f. Run analyze_geometry_for_cam to get features
   g. Classify geometry type using classify_geometry_type(features)
   h. Initialize SQLite schema (safe to call multiple times)

   i. **Preference check** (per CONTEXT.md):
      - If not use_defaults, call get_preference(material, geometry_type)
      - If no preference exists AND not use_defaults:
        Return "preference_needed" status with suggested_defaults
        Include message asking user to establish preference

   j. Use offsets from: custom_offsets > preference > DEFAULT_OFFSETS

   k. Calculate stock dimensions using calculate_stock_dimensions()

   l. Get orientation from body_result["suggested_orientations"] (from Phase 2)

   m. **Orientation confidence check** (per CONTEXT.md):
      - If best orientation score < 0.7 AND not selected_orientation provided:
        Return "orientation_choice_needed" status with alternatives
      - If selected_orientation provided, use that orientation from alternatives

   n. Detect cylindrical part using detect_cylindrical_part(body, features)

   o. Build response with:
      ```python
      {
          "status": "success",
          "stock_dimensions": {
              "rectangular": {
                  "width": {...},
                  "depth": {...},
                  "height": {...}
              },
              "round": {
                  "diameter": {...},
                  "length": {...}
              } if cylindrical["is_cylindrical"] else None
          },
          "recommended_shape": "round" if cylindrical["is_cylindrical"] else "rectangular",
          "shape_trade_offs": cylindrical.get("trade_offs"),
          "orientation": {
              "recommended": orientation["axis"],
              "score": orientation["score"],
              "reasoning": orientation.get("reasoning"),
              "alternatives": [...] if close_alternatives else []
          },
          "setup_sequence": orientation.get("setup_sequence", []),
          "offsets_applied": offsets,
          "source": preference["source"] if preference else "from: default",
          "material": material,
          "geometry_type": geometry_type,
          "unit_system": unit_system
      }
      ```

   p. **Close alternatives** (per CONTEXT.md discretion):
      - If any alternative orientation has score within 15% (0.15) of best, include in alternatives

   q. If save_preference argument is True, call save_preference()

3. Add handler to route_cam_operation handlers dict:
   ```python
   'suggest_stock_setup': handle_suggest_stock_setup,
   ```

4. Add docstring explaining arguments and return statuses:
   - "success": Full stock suggestion returned
   - "preference_needed": User should establish preference first
   - "orientation_choice_needed": User should select orientation (low confidence)
  </action>
  <verify>
    - File modified: Fusion-360-MCP-Server/cam_operations.py
    - Python syntax valid: python -c "import cam_operations; print('OK')"
    - Handler registered: grep "suggest_stock_setup" cam_operations.py shows handler in route_cam_operation
    - Import block exists for stock_suggestions
  </verify>
  <done>
    - handle_suggest_stock_setup implemented with all CONTEXT.md requirements
    - Three return statuses: success, preference_needed, orientation_choice_needed
    - Setup sequence always included (even single-setup)
    - Source attribution on every response
    - Close alternatives shown when within 15% score
    - Handler registered in route_cam_operation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete suggest_stock_setup operation that:
    - Calculates stock dimensions from geometry with standard size rounding
    - Detects cylindrical parts and shows both stock shape options
    - Prompts when no preference exists or orientation confidence is low
    - Includes setup sequence with every suggestion
    - Shows source attribution (from: user_preference or from: default)
  </what-built>
  <how-to-verify>
    1. Open Fusion 360 with a test part (any solid body)
    2. Ensure MCP-Link add-in is running
    3. Call suggest_stock_setup via MCP (e.g., through Claude):
       - First call: No material specified, should get "preference_needed" response
       - Second call with use_defaults=true: Should get full suggestion
       - Third call with save_preference=true: Should save preference
       - Fourth call: Should get "from: user_preference" source
    4. Verify response includes:
       - stock_dimensions with width/depth/height in mm
       - recommended_shape (rectangular or round)
       - orientation with score and setup_sequence
       - source attribution
    5. If part is roughly cylindrical, verify shape_trade_offs shown
    6. Test with low-confidence orientation (irregular part) to verify orientation_choice_needed prompt
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After implementation:
1. Handler syntax: python -c "from cam_operations import handle_suggest_stock_setup; print('OK')"
2. Handler registered: grep -c "'suggest_stock_setup'" cam_operations.py returns 1
3. Manual test in Fusion 360 with MCP-Link running
</verification>

<success_criteria>
- suggest_stock_setup callable via MCP protocol
- Returns stock dimensions rounded to standard sizes
- Prompts user when preferences missing (not silent defaults)
- Prompts user when orientation confidence low
- Setup sequence always included
- Source attribution always shown
- Cylindrical parts show both rectangular and round options
- Human-verified working in Fusion 360
</success_criteria>

<output>
After completion, create `.planning/phases/03-stock-suggestions/03-03-SUMMARY.md`
</output>

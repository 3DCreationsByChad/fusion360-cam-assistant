---
phase: 05-learning-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Fusion-360-MCP-Server/cam_operations.py
  - Fusion-360-MCP-Server/mcp_integration.py
autonomous: false

must_haves:
  truths:
    - "AI client can call record_user_choice to store feedback events"
    - "AI client can call get_feedback_stats to view acceptance rates"
    - "AI client can call export_feedback_history to get CSV or JSON export"
    - "AI client can call clear_feedback_history to reset per-category or all"
    - "suggest_stock_setup adjusts confidence based on historical feedback"
    - "suggest_toolpath_strategy adjusts confidence based on historical feedback"
    - "Source tag shows 'user_preference' when learning influences suggestions"
    - "First-time learning notification appears when 3rd sample is recorded"
    - "tool_description documents all four new operations for MCP discovery"
  artifacts:
    - path: "Fusion-360-MCP-Server/cam_operations.py"
      provides: "MCP handlers for record_user_choice, get_feedback_stats, export_feedback_history, clear_feedback_history, plus learning integration in existing handlers"
      contains: "handle_record_user_choice"
    - path: "Fusion-360-MCP-Server/mcp_integration.py"
      provides: "Updated tool_description with four new operations and operation routing"
      contains: "record_user_choice"
  key_links:
    - from: "Fusion-360-MCP-Server/cam_operations.py"
      to: "Fusion-360-MCP-Server/feedback_learning/__init__.py"
      via: "import guard with FEEDBACK_LEARNING_AVAILABLE flag"
      pattern: "from .feedback_learning import"
    - from: "Fusion-360-MCP-Server/cam_operations.py"
      to: "handle_suggest_stock_setup"
      via: "learning integration calls get_matching_feedback + adjust_confidence"
      pattern: "adjust_confidence_from_feedback"
    - from: "Fusion-360-MCP-Server/cam_operations.py"
      to: "handle_suggest_toolpath_strategy"
      via: "learning integration calls get_matching_feedback + adjust_confidence"
      pattern: "adjust_confidence_from_feedback"
    - from: "Fusion-360-MCP-Server/mcp_integration.py"
      to: "cam_operations.route_cam_operation"
      via: "operation routing includes new operations"
      pattern: "record_user_choice.*get_feedback_stats.*export_feedback_history.*clear_feedback_history"
---

<objective>
Wire the feedback learning module into MCP protocol: create four new MCP operations (record_user_choice, get_feedback_stats, export_feedback_history, clear_feedback_history), integrate learning into existing suggest_stock_setup and suggest_toolpath_strategy handlers, and update tool_description for AI client discovery.

Purpose: This connects the Plan 01 computation layer to the MCP interface, making the learning system accessible to the AI client and active in suggestion generation.

Output: Updated cam_operations.py with new handlers + learning integration, updated mcp_integration.py with tool_description documentation and routing.
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-learning-system/05-01-SUMMARY.md

Key reference files:
@Fusion-360-MCP-Server/cam_operations.py
@Fusion-360-MCP-Server/mcp_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add four new MCP handlers and integrate learning into existing handlers in cam_operations.py</name>
  <files>
    Fusion-360-MCP-Server/cam_operations.py
  </files>
  <action>
Modify `cam_operations.py` to add the feedback learning system. This task touches one file with multiple sections.

**1. Add import guard at top of file (after the toolpath_strategy import block):**

```python
# Feedback learning module for recording user choices and adjusting
# confidence scores based on historical acceptance rates
try:
    from .feedback_learning import (
        initialize_feedback_schema,
        record_feedback,
        get_feedback_statistics,
        export_feedback_history,
        clear_feedback_history,
        get_matching_feedback,
        adjust_confidence_from_feedback,
        should_notify_learning,
        get_conflicting_choices
    )
    FEEDBACK_LEARNING_AVAILABLE = True
except ImportError:
    FEEDBACK_LEARNING_AVAILABLE = False
```

**2. Add handle_record_user_choice handler:**

New section after handle_suggest_toolpath_strategy. Creates a handler for the `record_user_choice` MCP operation.

Arguments:
- operation_type (str, required): 'stock_setup', 'toolpath_strategy', 'tool_selection'
- material (str, required): Material name
- geometry_type (str, optional): Geometry classification. If not provided and body_name is given, auto-detect from features using classify_geometry_type.
- body_name (str, optional): Part body name for auto-detection of geometry_type
- suggestion (dict, required): Original suggestion that was presented (full JSON payload)
- user_choice (dict, optional): What user selected instead. NULL/omit = accepted suggestion.
- feedback_type (str, optional): Default 'implicit'. If 'implicit': auto-detect as 'implicit_accept' (user_choice is None) or 'implicit_reject' (user_choice is not None). Can also be 'explicit_good' or 'explicit_bad'.
- note (str, optional): Reason for override

Handler logic:
1. Check FEEDBACK_LEARNING_AVAILABLE, return error if not
2. Validate required fields (operation_type, material, suggestion)
3. Auto-detect geometry_type from body_name if needed (call handle_analyze_geometry_for_cam + classify_geometry_type from stock_suggestions)
4. If geometry_type still missing, return error with "Provide either geometry_type or body_name"
5. Auto-detect feedback_type: 'implicit' + user_choice=None -> 'implicit_accept'; 'implicit' + user_choice!=None -> 'implicit_reject'
6. Build context snapshot dict: {operation_type, material, geometry_type}
7. Get mcp_call_func from arguments.get('_mcp_call_func')
8. Call initialize_feedback_schema(mcp_call_func) (safe to call multiple times)
9. Call record_feedback(...) with all params
10. Return success response: {"status": "recorded", "operation_type": X, "feedback_type": Y, "message": "Feedback recorded successfully"}
11. On failure: return error with _format_error

**3. Add handle_get_feedback_stats handler:**

Arguments:
- operation_type (str, optional): Filter stats to specific operation type

Handler logic:
1. Check FEEDBACK_LEARNING_AVAILABLE
2. Get mcp_call_func, initialize schema
3. Call get_feedback_statistics(operation_type, mcp_call_func)
4. Return formatted response with stats dict

**4. Add handle_export_feedback_history handler:**

Arguments:
- format (str, optional): 'csv' or 'json' (default: 'json')
- operation_type (str, optional): Filter export to specific operation type

Handler logic:
1. Check FEEDBACK_LEARNING_AVAILABLE
2. Get mcp_call_func, initialize schema
3. Call export_feedback_history(format, operation_type, mcp_call_func)
4. Return formatted response with export string

**5. Add handle_clear_feedback_history handler:**

Arguments:
- operation_type (str, optional): If provided, clear only that category. If omitted, clear all.
- confirm (bool, required): Must be true to proceed (safety check)

Handler logic:
1. Check FEEDBACK_LEARNING_AVAILABLE
2. Check confirm == True, otherwise return error "Set confirm=true to clear feedback history"
3. Get mcp_call_func, initialize schema
4. Call clear_feedback_history(operation_type, mcp_call_func)
5. Return formatted response with deleted_count

**6. Integrate learning into handle_suggest_stock_setup:**

After the preference check section and before the stock dimension calculation section (around line ~1155-1180), add learning integration:

```python
# ---------------------------------------------------------------------
# Learning integration: adjust confidence from feedback history
# ---------------------------------------------------------------------
learning_metadata = None
if FEEDBACK_LEARNING_AVAILABLE and mcp_call_func:
    try:
        initialize_feedback_schema(mcp_call_func)
        feedback_history = get_matching_feedback(
            operation_type="stock_setup",
            material=material,
            geometry_type=geometry_type,
            limit=50,
            mcp_call_func=mcp_call_func
        )
        if feedback_history:
            base_confidence = 0.8  # Default stock suggestion confidence
            adjusted_confidence, learning_source = adjust_confidence_from_feedback(
                base_confidence=base_confidence,
                feedback_history=feedback_history
            )
            learning_metadata = {
                "sample_count": len(feedback_history),
                "adjusted_confidence": adjusted_confidence,
                "source": learning_source
            }
            # Override source tag if learning has kicked in
            if learning_source.startswith("user_preference"):
                source = f"from: {learning_source}"
            # First-time learning notification
            if should_notify_learning(feedback_history):
                learning_metadata["notification"] = (
                    f"I noticed patterns in your preferences for {material}. "
                    "Future suggestions will reflect what you've chosen before."
                )
    except Exception:
        pass  # Learning is non-critical, don't break suggestions
```

Add `learning_metadata` to the success response dict (after "source" key).

**7. Integrate learning into handle_suggest_toolpath_strategy:**

After the preference check section and before the feature processing loop (around line ~1600-1608), add similar learning integration:

Same pattern as stock_setup but with operation_type="toolpath_strategy". Add learning_metadata to each suggestion if feedback exists for that feature type. Check feedback for the specific (material + geometry_type) context.

Add `learning_metadata` to the final response dict.

**8. Update route_cam_operation:**

Uncomment and add the new operations to the handlers dict:
```python
handlers = {
    'get_cam_state': handle_get_cam_state,
    'get_tool_library': handle_get_tool_library,
    'analyze_geometry_for_cam': handle_analyze_geometry_for_cam,
    'suggest_stock_setup': handle_suggest_stock_setup,
    'suggest_toolpath_strategy': handle_suggest_toolpath_strategy,
    'record_user_choice': handle_record_user_choice,
    'get_feedback_stats': handle_get_feedback_stats,
    'export_feedback_history': handle_export_feedback_history,
    'clear_feedback_history': handle_clear_feedback_history,
    # Phase 6+
    # 'suggest_post_processor': handle_suggest_post_processor,
}
```

**9. Update module docstring** at top of file to include the four new operations.

CRITICAL: Learning integration must be wrapped in try/except and never break existing suggestion functionality. If feedback_learning module fails to import or any learning call fails, the existing behavior must continue unchanged.
  </action>
  <verify>
Read cam_operations.py and confirm:
1. FEEDBACK_LEARNING_AVAILABLE import guard exists at top
2. handle_record_user_choice validates required fields and auto-detects feedback_type
3. handle_get_feedback_stats returns statistics dict
4. handle_export_feedback_history supports csv and json
5. handle_clear_feedback_history requires confirm=true
6. handle_suggest_stock_setup has learning integration wrapped in try/except
7. handle_suggest_toolpath_strategy has learning integration wrapped in try/except
8. route_cam_operation includes all four new operations
9. Module docstring lists all operations
10. No breakage of existing handler logic (learning is additive only)
  </verify>
  <done>
cam_operations.py has four new handlers (record_user_choice, get_feedback_stats, export_feedback_history, clear_feedback_history), learning integration in both suggest_stock_setup and suggest_toolpath_strategy, and updated routing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mcp_integration.py tool_description and operation routing for AI client discovery</name>
  <files>
    Fusion-360-MCP-Server/mcp_integration.py
  </files>
  <action>
Modify `mcp_integration.py` to document the new operations and update routing.

**1. Update the tool_description variable** in `_create_mcp_client()`.

Replace the "coming soon" lines:
```
### record_user_choice - Store Feedback for Learning (coming soon)
### suggest_post_processor - Match Machine to Post (coming soon)
```

With full documentation for four new operations:

```
### record_user_choice - Store Feedback for Learning
{
  "operation": "record_user_choice",
  "operation_type": "stock_setup",
  "material": "Aluminum",
  "suggestion": {"stock_dimensions": {...}, "confidence_score": 0.85},
  "user_choice": {"stock_dimensions": {...}},
  "feedback_type": "implicit",
  "note": "Preferred larger stock for this material"
}
Records when user accepts or overrides a suggestion. Required: operation_type, material, suggestion.
- operation_type: 'stock_setup', 'toolpath_strategy', or 'tool_selection'
- suggestion: The full JSON suggestion that was presented
- user_choice: What user selected instead (omit if accepted suggestion as-is)
- feedback_type: 'implicit' (auto-detected), 'explicit_good', or 'explicit_bad'
- geometry_type: Auto-detected from body_name if not provided
- note: Optional reason for override
The system learns from these events and adjusts future suggestion confidence scores.

### get_feedback_stats - View Learning Statistics
{
  "operation": "get_feedback_stats",
  "operation_type": "stock_setup"
}
Returns acceptance rates broken down by operation type, material, and geometry type.
Optional operation_type filter. Shows overall acceptance rate and per-category breakdowns.

### export_feedback_history - Export Feedback Data
{
  "operation": "export_feedback_history",
  "format": "json",
  "operation_type": "toolpath_strategy"
}
Exports all feedback history as CSV or JSON. Optional operation_type filter.
format: 'csv' or 'json' (default: 'json')

### clear_feedback_history - Reset Learning Data
{
  "operation": "clear_feedback_history",
  "operation_type": "stock_setup",
  "confirm": true
}
Clears feedback history for a specific operation type or all. Requires confirm=true.
Omit operation_type to clear all feedback. Per-category reset supported.

### suggest_post_processor - Match Machine to Post (coming soon)
```

**2. Update the operation routing** in `_fusion_tool_handler_impl()`.

Find the line that routes CAM operations:
```python
elif operation in ['get_cam_state', 'get_tool_library', 'analyze_geometry_for_cam',
                   'suggest_stock_setup', 'suggest_toolpath_strategy',
                   'record_user_choice', 'suggest_post_processor']:
```

Update it to include all new operations:
```python
elif operation in ['get_cam_state', 'get_tool_library', 'analyze_geometry_for_cam',
                   'suggest_stock_setup', 'suggest_toolpath_strategy',
                   'record_user_choice', 'get_feedback_stats',
                   'export_feedback_history', 'clear_feedback_history',
                   'suggest_post_processor']:
```

IMPORTANT per MEMORY.md: The `tool_description` variable is what the AI client sees via MCP protocol. If an operation says "coming soon", the AI won't call it. Documenting an operation there is REQUIRED for discoverability.
  </action>
  <verify>
Read mcp_integration.py and confirm:
1. tool_description has full documentation for record_user_choice (not "coming soon")
2. tool_description has documentation for get_feedback_stats
3. tool_description has documentation for export_feedback_history
4. tool_description has documentation for clear_feedback_history
5. suggest_post_processor remains "coming soon"
6. Operation routing list includes all four new operations
7. JSON examples in tool_description are valid format
  </verify>
  <done>
mcp_integration.py tool_description documents all four new operations with examples and descriptions. Operation routing includes all four new operations. AI client can discover and call all learning system operations.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 5 learning system:
1. feedback_learning/ module with SQLite storage, exponential decay weighting, confidence adjustment, and context matching
2. Four new MCP operations: record_user_choice, get_feedback_stats, export_feedback_history, clear_feedback_history
3. Learning integration in suggest_stock_setup and suggest_toolpath_strategy
4. Full tool_description documentation for AI client discovery
  </what-built>
  <how-to-verify>
1. Restart the MCP-Link add-in in Fusion 360 (Tools > Add-Ins > Stop MCP-Link > Run MCP-Link)
2. Open a part with some features (holes, pockets, etc.)
3. Test basic operations still work:
   - Call suggest_stock_setup — should return suggestions as before
   - Call suggest_toolpath_strategy — should return strategies as before
4. Test feedback recording:
   - Call record_user_choice with a stock_setup suggestion and a user override
   - Call get_feedback_stats — should show 1 event
   - Record 2 more feedback events for same material+geometry
   - Call get_feedback_stats — should show 3 events
5. Test learning influence:
   - After 3+ feedback events, call suggest_stock_setup again
   - Response should include learning_metadata with adjusted confidence
   - Source tag should show 'user_preference' or 'user_preference_tentative'
6. Test export:
   - Call export_feedback_history with format="json" — should return JSON
   - Call export_feedback_history with format="csv" — should return CSV
7. Test clear:
   - Call clear_feedback_history with operation_type="stock_setup" and confirm=true
   - Call get_feedback_stats — stock_setup count should be 0
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. All feedback_learning/ module files exist and import correctly
2. cam_operations.py has four new handlers registered in route_cam_operation
3. mcp_integration.py tool_description documents all four new operations
4. suggest_stock_setup and suggest_toolpath_strategy integrate learning non-breakingly
5. record_user_choice stores feedback with full context snapshots
6. get_feedback_stats returns acceptance rate breakdowns
7. export_feedback_history supports CSV and JSON
8. clear_feedback_history supports per-category reset
9. Learning requires 3+ samples before adjusting (no premature changes)
10. Explicit feedback gets 2x weight
11. Confidence never drops below 0.20 floor
12. "coming soon" removed from record_user_choice in tool_description
13. Human verified in Fusion 360
</verification>

<success_criteria>
- Four new MCP operations callable from AI client
- Learning silently improves over time (per CONTEXT.md "learn silently in the background")
- Override patterns detected after 3+ samples
- User can ask why something was suggested (source attribution)
- Acceptance rates are simple and interpretable
- Existing operations not broken by learning integration
- Human verified in Fusion 360
</success_criteria>

<output>
After completion, create `.planning/phases/05-learning-system/05-02-SUMMARY.md`
</output>

---
phase: 02-geometry-analysis
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Fusion-360-MCP-Server/geometry_analysis/feature_detector.py
  - Fusion-360-MCP-Server/geometry_analysis/confidence_scorer.py
  - Fusion-360-MCP-Server/cam_operations.py
autonomous: true

must_haves:
  truths:
    - "Slots distinguished from pockets using aspect ratio heuristic (>3.0)"
    - "Every feature has confidence score between 0.0 and 1.0"
    - "Every feature has reasoning text explaining classification"
    - "Ambiguous features have needs_review: true flag"
    - "Features grouped by machining priority, not by type"
  artifacts:
    - path: "Fusion-360-MCP-Server/geometry_analysis/confidence_scorer.py"
      provides: "Confidence scoring heuristics"
      exports: ["calculate_confidence", "CONFIDENCE_THRESHOLDS"]
    - path: "Fusion-360-MCP-Server/geometry_analysis/feature_detector.py"
      provides: "Slot classification and confidence scoring"
      contains: "aspect_ratio"
    - path: "Fusion-360-MCP-Server/cam_operations.py"
      provides: "Features grouped by machining priority in output"
      contains: "features_by_priority"
  key_links:
    - from: "feature_detector.py"
      to: "confidence_scorer.py"
      via: "import calculate_confidence"
      pattern: "calculate_confidence"
    - from: "cam_operations.py"
      to: "feature_detector.py"
      via: "priority grouping logic"
      pattern: "features_by_priority"
---

<objective>
Implement feature classification with slot heuristics, confidence scoring, reasoning text, and machining priority grouping.

Purpose: Transform raw feature detection into actionable CAM data by classifying pockets vs slots, adding confidence scores that indicate reliability of classification, and grouping features by how they should be machined (drilling first, then roughing, then finishing).

Output: Enhanced feature_detector.py with slot classification, new confidence_scorer.py module, and priority-grouped output in cam_operations.py.
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-geometry-analysis/02-CONTEXT.md
@.planning/phases/02-geometry-analysis/02-RESEARCH.md

# Prior plan output
@.planning/phases/02-geometry-analysis/02-01-SUMMARY.md

# Current implementation
@Fusion-360-MCP-Server/geometry_analysis/feature_detector.py
@Fusion-360-MCP-Server/cam_operations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confidence scoring module</name>
  <files>Fusion-360-MCP-Server/geometry_analysis/confidence_scorer.py</files>
  <action>
Create `confidence_scorer.py` with:

**Constants:**
```python
CONFIDENCE_THRESHOLDS = {
    "needs_review": 0.80,  # Below this, flag needs_review: true
    "high": 0.90,
    "medium": 0.70,
    "low": 0.50
}

# Base confidence by detection source (per RESEARCH.md Pattern 4)
BASE_CONFIDENCE = {
    "fusion_api": 0.95,      # RecognizedHole/RecognizedPocket
    "brep_analysis": 0.75,   # Custom BRep loop traversal
    "heuristic": 0.60        # Aspect ratio, depth/diameter rules
}
```

**`calculate_confidence(detection_source, geometry_complexity, ambiguity_flags) -> tuple[float, str]`**:
- Args:
  - detection_source: "fusion_api", "brep_analysis", or "heuristic"
  - geometry_complexity: int 0-10 (0=simple hole, 10=complex multi-segment)
  - ambiguity_flags: list of strings describing ambiguous conditions
- Returns: (confidence_score, reasoning_text)
- Logic:
  - Start with BASE_CONFIDENCE[detection_source]
  - Subtract complexity_penalty: min(geometry_complexity / 100, 0.15)
  - Subtract ambiguity_penalty: min(len(ambiguity_flags) * 0.05, 0.25)
  - Floor at 0.30
  - Build reasoning: "{detection_source} detection" + complexity/ambiguity notes
- Example outputs:
  - (0.95, "Fusion API detection (simple geometry)")
  - (0.75, "Heuristic classification: aspect ratio 3.2:1 suggests slot; ambiguous range (2.5-3.5)")

**`needs_review(confidence) -> bool`**: Return confidence < CONFIDENCE_THRESHOLDS["needs_review"]

**`get_ambiguity_flags(feature_type, metrics) -> list[str]`**:
- For pockets/slots: Check aspect_ratio in ambiguous range (2.5-3.5)
- For holes: Check segment_count > 3
- For blind features: Check depth/diameter ratio in 3-4:1 range
  </action>
  <verify>
`python -m py_compile Fusion-360-MCP-Server/geometry_analysis/confidence_scorer.py`
  </verify>
  <done>
confidence_scorer.py exists with calculate_confidence, needs_review, get_ambiguity_flags functions and CONFIDENCE_THRESHOLDS constant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add slot classification and confidence to feature detector</name>
  <files>Fusion-360-MCP-Server/geometry_analysis/feature_detector.py</files>
  <action>
Enhance feature_detector.py:

1. **Import confidence scorer**:
   ```python
   from .confidence_scorer import calculate_confidence, needs_review, get_ambiguity_flags
   ```

2. **Add slot detection config** at module level:
   ```python
   DEFAULT_CONFIG = {
       "slot_aspect_ratio_threshold": 3.0,
       "slot_ambiguous_range": (2.5, 3.5),
       "min_feature_size_mm": 0.5
   }
   ```

3. **Enhance `detect_pockets()` to classify slots**:
   - After getting pocket from Fusion API, calculate bounding box
   - Compute aspect_ratio = max(length, width) / min(length, width)
   - Classification logic:
     - If aspect_ratio > config["slot_aspect_ratio_threshold"]: type="slot"
     - Else: type="pocket"
   - Add to each feature:
     - "aspect_ratio": round(aspect_ratio, 2)
     - "confidence": confidence_score
     - "reasoning": reasoning_text (from calculate_confidence)
     - "needs_review": needs_review(confidence_score)
   - For aspect_ratio in ambiguous_range, add "aspect_ratio_ambiguous" to ambiguity_flags

4. **Enhance `detect_holes()` with confidence**:
   - For each hole:
     - complexity = min(hole.segmentCount * 2, 10)
     - ambiguity_flags from get_ambiguity_flags("hole", {"segment_count": hole.segmentCount})
     - Calculate confidence and reasoning
     - Add confidence, reasoning, needs_review to feature dict

5. **Update `__init__.py`** to export DEFAULT_CONFIG if needed.
  </action>
  <verify>
`python -m py_compile Fusion-360-MCP-Server/geometry_analysis/feature_detector.py`
`grep -n "aspect_ratio\|confidence\|reasoning\|needs_review" Fusion-360-MCP-Server/geometry_analysis/feature_detector.py`
  </verify>
  <done>
feature_detector.py classifies slots using aspect ratio >3.0, all features have confidence score with reasoning text, ambiguous features flagged with needs_review.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement machining priority grouping in cam_operations</name>
  <files>Fusion-360-MCP-Server/cam_operations.py</files>
  <action>
Update cam_operations.py to group features by machining priority (per CONTEXT.md locked decision):

1. **Add priority grouping helper function** (near other helpers):
   ```python
   def _group_by_machining_priority(features: list) -> list:
       """
       Group features by machining priority per CONTEXT.md decision.
       Priority 1: Drilling operations (small holes, spotting)
       Priority 2: Roughing operations (deep pockets, large material removal)
       Priority 3: Finishing operations (shallow features, fine details)
       """
       priority_groups = {
           1: {"name": "drilling_operations", "description": "Holes suitable for drilling", "features": []},
           2: {"name": "roughing_operations", "description": "Features requiring significant material removal", "features": []},
           3: {"name": "finishing_operations", "description": "Shallow features and fine details", "features": []}
       }

       for feature in features:
           # Priority heuristics
           ftype = feature.get("type", "")
           diameter = feature.get("diameter", {}).get("value", 0) if isinstance(feature.get("diameter"), dict) else 0
           depth = feature.get("depth", {}).get("value", 0) if isinstance(feature.get("depth"), dict) else 0

           if ftype == "hole" and diameter < 12.0:  # Small holes: drill
               priority = 1
           elif ftype in ["pocket", "slot"] and depth > 10.0:  # Deep features: rough
               priority = 2
           else:  # Everything else: finish
               priority = 3

           priority_groups[priority]["features"].append(feature)

       # Return only non-empty groups, sorted by priority
       return [g for p, g in sorted(priority_groups.items()) if g["features"]]
   ```

2. **Update `handle_analyze_geometry_for_cam()` result structure**:
   - After getting recognized_features (holes + pockets/slots), call _group_by_machining_priority
   - Add to body_result:
     ```python
     body_result["features_by_priority"] = _group_by_machining_priority(all_recognized_features)
     body_result["feature_count"] = {
         "holes": len(holes),
         "pockets": len([f for f in pockets if f.get("type") == "pocket"]),
         "slots": len([f for f in pockets if f.get("type") == "slot"]),
         "total": len(all_recognized_features)
     }
     ```

3. **Ensure confidence and reasoning are passed through** from feature detector to final output.
  </action>
  <verify>
`python -m py_compile Fusion-360-MCP-Server/cam_operations.py`
`grep -n "features_by_priority\|_group_by_machining_priority" Fusion-360-MCP-Server/cam_operations.py`
  </verify>
  <done>
cam_operations.py includes _group_by_machining_priority helper and returns features_by_priority in analyze_geometry_for_cam output with drilling/roughing/finishing groups.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. All Python files pass syntax check
2. `grep -r "confidence\|reasoning" Fusion-360-MCP-Server/geometry_analysis/` shows confidence scoring
3. `grep "aspect_ratio.*3.0" Fusion-360-MCP-Server/geometry_analysis/feature_detector.py` shows slot threshold
4. `grep "features_by_priority" Fusion-360-MCP-Server/cam_operations.py` shows priority grouping
5. `grep "needs_review" Fusion-360-MCP-Server/geometry_analysis/` shows review flagging
</verification>

<success_criteria>
- confidence_scorer.py provides calculate_confidence with source-based scoring
- feature_detector.py classifies slots using aspect_ratio > 3.0
- All features have confidence (0-1), reasoning (text), needs_review (bool)
- Ambiguous features (aspect_ratio 2.5-3.5) flagged needs_review: true
- cam_operations.py groups features by machining priority (drilling, roughing, finishing)
- All Python files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-geometry-analysis/02-02-SUMMARY.md`
</output>

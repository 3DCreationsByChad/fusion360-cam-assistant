---
phase: 02-geometry-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Fusion-360-MCP-Server/geometry_analysis/__init__.py
  - Fusion-360-MCP-Server/geometry_analysis/feature_detector.py
  - Fusion-360-MCP-Server/cam_operations.py
autonomous: true

must_haves:
  truths:
    - "Holes detected using Fusion RecognizedHole API"
    - "Pockets detected using Fusion RecognizedPocket API"
    - "Each feature has entityToken for programmatic selection"
    - "Feature detection returns structured data with dimensions"
  artifacts:
    - path: "Fusion-360-MCP-Server/geometry_analysis/__init__.py"
      provides: "Module initialization"
    - path: "Fusion-360-MCP-Server/geometry_analysis/feature_detector.py"
      provides: "FeatureDetector class with detect_holes, detect_pockets methods"
      min_lines: 100
    - path: "Fusion-360-MCP-Server/cam_operations.py"
      provides: "Updated analyze_geometry_for_cam using new feature detector"
      contains: "from geometry_analysis.feature_detector import"
  key_links:
    - from: "cam_operations.py"
      to: "feature_detector.py"
      via: "import and function calls"
      pattern: "detect_holes|detect_pockets"
---

<objective>
Implement feature detection foundation using Fusion 360's RecognizedHole and RecognizedPocket APIs.

Purpose: Replace basic face-type detection with production-ready feature recognition that provides actionable CAM data with Fusion geometry IDs for programmatic selection.

Output: `geometry_analysis/` module with `FeatureDetector` class that wraps Fusion's native feature recognition APIs.
</objective>

<execution_context>
@C:\Users\cdeit\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cdeit\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-geometry-analysis/02-CONTEXT.md
@.planning/phases/02-geometry-analysis/02-RESEARCH.md

# Existing implementation
@Fusion-360-MCP-Server/cam_operations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geometry_analysis module with feature detector</name>
  <files>
    - Fusion-360-MCP-Server/geometry_analysis/__init__.py
    - Fusion-360-MCP-Server/geometry_analysis/feature_detector.py
  </files>
  <action>
Create `geometry_analysis/` directory with:

1. **`__init__.py`**: Export FeatureDetector class

2. **`feature_detector.py`**: Implement FeatureDetector class with:

   **`detect_holes(body) -> List[dict]`**:
   - Use `adsk.cam.RecognizedHole.recognizeHoles([body])`
   - For each hole:
     - Extract segment information (Cylinder, Cone, Flat, Torus)
     - Get diameter from first cylindrical segment (convert cm to mm)
     - Get hole depth (sum of segment lengths)
     - Get `hole.faces` and extract `entityToken` for each face
     - Build feature dict with: type, diameter, depth, segment_count, fusion_faces (list of entityTokens)
   - Handle errors gracefully - if API fails, return empty list with error flag

   **`detect_pockets(body, tool_direction=None) -> List[dict]`**:
   - Default tool_direction: `Vector3D.create(0, 0, -1)` (Z-down)
   - Use `adsk.cam.RecognizedPocket.recognizePockets(body, tool_direction)`
   - For each pocket:
     - Get `pocket.depth` (convert cm to mm)
     - Get `pocket.faces` and extract `entityToken` for each face
     - Calculate bounding box from face positions
     - Check `pocket.isThrough` if available
     - Build feature dict with: type="pocket", depth, is_through, dimensions (bounding box), fusion_faces
   - Handle errors gracefully

   **Helper `_to_mm_unit(cm_value)`**: Returns `{"value": round(cm_value * 10, 3), "unit": "mm"}`

Reference Pattern 1 and Pattern 2 from 02-RESEARCH.md for API usage. Use try/except around API calls since RecognizedHole/RecognizedPocket may not be available in all Fusion versions.
  </action>
  <verify>
Python syntax check: `python -m py_compile Fusion-360-MCP-Server/geometry_analysis/feature_detector.py`
  </verify>
  <done>
feature_detector.py exists with detect_holes and detect_pockets methods that use Fusion CAM APIs and return structured feature dicts with entityTokens.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate feature detector into cam_operations.py</name>
  <files>Fusion-360-MCP-Server/cam_operations.py</files>
  <action>
Update `handle_analyze_geometry_for_cam()` to use the new FeatureDetector:

1. **Add import** at top of file (inside the try/except for Fusion imports):
   ```python
   try:
       from geometry_analysis.feature_detector import FeatureDetector
       FEATURE_DETECTOR_AVAILABLE = True
   except ImportError:
       FEATURE_DETECTOR_AVAILABLE = False
   ```

2. **Modify feature detection section** (around line 610 where features are detected):
   - If `FEATURE_DETECTOR_AVAILABLE` and analysis_type is 'full':
     - Create detector: `detector = FeatureDetector()`
     - Detect holes: `holes = detector.detect_holes(body)`
     - Detect pockets: `pockets = detector.detect_pockets(body)`
     - Merge into features list
   - Keep existing face-type detection as fallback for when API not available

3. **Update result structure**:
   - Add new field `"recognized_features"` with holes and pockets from detector
   - Keep existing `"features"` field as `"face_features"` for backward compatibility
   - Add `"feature_detection_source": "fusion_api" | "face_analysis"` to indicate which method was used

4. **Preserve existing functionality**: Do not remove the face-based detection (planar, cylindrical, etc.) - it provides useful supplementary data.
  </action>
  <verify>
Python syntax check: `python -m py_compile Fusion-360-MCP-Server/cam_operations.py`

Check import structure exists:
```bash
grep -n "from geometry_analysis" Fusion-360-MCP-Server/cam_operations.py
grep -n "FEATURE_DETECTOR_AVAILABLE" Fusion-360-MCP-Server/cam_operations.py
```
  </verify>
  <done>
cam_operations.py imports FeatureDetector and uses it in analyze_geometry_for_cam. Result includes "recognized_features" with holes and pockets from Fusion API, plus "feature_detection_source" indicator.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `python -m py_compile Fusion-360-MCP-Server/geometry_analysis/feature_detector.py` - no errors
2. `python -m py_compile Fusion-360-MCP-Server/cam_operations.py` - no errors
3. `grep -r "RecognizedHole\|RecognizedPocket" Fusion-360-MCP-Server/` - shows API usage
4. `grep -r "entityToken" Fusion-360-MCP-Server/geometry_analysis/` - shows geometry ID extraction
</verification>

<success_criteria>
- geometry_analysis/ module exists with feature_detector.py
- detect_holes uses adsk.cam.RecognizedHole.recognizeHoles
- detect_pockets uses adsk.cam.RecognizedPocket.recognizePockets
- Each feature includes fusion_faces list with entityTokens
- cam_operations.py integrates the new detector with graceful fallback
- All Python files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-geometry-analysis/02-01-SUMMARY.md`
</output>
